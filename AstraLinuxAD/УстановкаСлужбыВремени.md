#### Установка службы chrony.

>[!Warning]
>Серверная служба chronyd (пакет chrony) Может обеспечивать работу ОС в режиме как сервера точного времени, так и клиента. Является штатной службой времени для использования с контроллерами домена FreeIPA.

```bash
sudo systemctl status chrony
если не установлена, установить можно так
sudo apt install chrony
sudo systemctl start chrony
sudo systemctl enable chrony     //добавим и запустить службу синхронизации времени chrony в автозапуск.
```
Добавим Российские NTP сервера и можно указать разрешённую сеть для клиентов.
Вводим ``nano /etc/chrony/chrony.conf`` и добавляем эти строки
```bash
server 0.ru.pool.ntp.org iburst
server 1.ru.pool.ntp.org iburst
server 2.ru.pool.ntp.org iburst
server 3.ru.pool.ntp.org iburst
allow 192.168.25.0/24
остальные пулы закоментируем
```
![image](https://github.com/user-attachments/assets/ca157da9-9fab-4755-bef8-f3dcb9bee0de)

![image](https://github.com/user-attachments/assets/3469c438-fb3d-42db-b247-a00a6b1b4d86)

- **server** — данная директива описывает NTP-сервер, с которым необходимо синхронизироваться.
- **stratumweight** — какую задержку следует добавить к источнику синхронизации для каждой группы. Значение по умолчанию — 0,0001.
- **driftfile** — расположение и имя файла, содержащего данные смещения.
- **makestep** — эта директива заставляет сервис постепенно корректировать любое смещение во времени путем снижения скорости или замедления хода часов по мере необходимости.
- **logdir** — путь к файлу журнала chrony.

После настройки сервера нужно перезапустить службу: ``sudo systemctl restart chrony``

Проверим источники времени:``sudo chronyc -N sources``

![image](https://github.com/user-attachments/assets/bf125dd1-102b-403d-bbab-50ad69c8a08d)

Проверим порт. Сервер времени chrony, также как и другие NTP сервера слушает порт udp 123: ``sudo ss -ulpn | grep chronyd``

![image](https://github.com/user-attachments/assets/1a51b4f4-3efc-41af-8519-2191b17ac14d)

Можем посмотреть количество активных и не активных источников: ``sudo chronyc activity``

Чтобы проверить, синхронизирован ли ``chrony`` на самом деле, мы будем использовать его программу командной строки ``chronyc``, которая имеет опцию отслеживания для предоставления соответствующей информации.
```bash
chronyc tracking
```
![image](https://github.com/user-attachments/assets/9a260c0f-2093-4f4a-b8fa-bf4e6ccb8511)

>Перечисленные пункты содержат следующую информацию:

- **Reference ID** — идентификатор и имя, с которым компьютер в настоящее время синхронизирован.
- **Stratum** — количество переходов к компьютеру с установленными основными часами.
- **Ref time** — это время по Гринвичу, в которое было выполнено последнее измерение из эталонного источника.
- **System time** — задержка системных часов от синхронизированного сервера.
- **Last offset** — расчетное смещение последнего обновления часов.
- **RMS offset** — долгосрочное среднее арифметическое значения смещения.
- **Frequency** — это частота, на которой часы системы будут работать неправильно, если хронограф не проведет коррекцию. Она выражена в ppm — ч/м (частей на миллион).
- **Residual freq** — остаточная частота указывает на разницу между измерениями от опорного источника и используемой в настоящее время частотой.
- **Skew** — расчетная погрешность, связанная с погрешностью частоты.
- **Root delay** — суммарная задержка сетевого пути к опорному серверу, с которым синхронизируется компьютер.
- **Leap status** — это статус, который может иметь одно из следующих значений — нормальное, добавить второй, удалить второй или не синхронизироваться.

>[Warning]
>Теперь нужно, на остальных серверах, прописать наш сервер Chrony в качестве источника синхронизации времени.
>Для этого укажем его адрес в ``/etc/systemd/timesyncd.conf`` на остальных серверах. А затем перезапустим службу синхронизации времени
```bash
[Time]
NTP=192.168.25.100
```
Сделаем перезагрузку и убедимся, что служба запускается автоматически.

>[!Warning]
>Серверная служба chronyd (пакет chrony) Может обеспечивать работу ОС в режиме как сервера точного времени, так и клиента. Является штатной службой времени для использования с контроллерами домена FreeIPA.<br>
>Если при начальной настройке будущего контроллера домена желаете использовать службу синхронизации времени ntp, то делается это следующим образом (но!!! после установки контроллера домана, будет всё равно использоваться служба chrony).

Если всё правильно сделали, должно быть так

![image](https://github.com/user-attachments/assets/4bd564fd-43de-429c-8d4c-feac646e1ff2)

Если нужно немедленно перейти к настройке системных часов и игнорировать текущие настройки, воспользуйтесь следующей командой:
```bash
chronyc makestep
```
#### Настраиваем на локальный сервер.

Чтобы настроить локальный сервер времени (local stratum) с помощью Chrony, нужно добавить конфигурационные строки в файл ``/etc/chrony.conf`` и указать, что сервер является локальным и имеет определенный стратум. 
```bash
nano /etc/chrony/chrony.conf
```
добавляем строки
```bash
 # Локальный сервер времени
   local stratum 8
   manual

   # Разрешаем доступ для конкретного IP или подсети
   allow 192.168.25.0/24  # Пример: разрешаем доступ из подсети 192.168.1.0
   allow 127.0.0.1  # Разрешаем доступ с локального хоста

   # driftfile - файл, в котором хранится информация об изменении времени
   driftfile /var/lib/chrony/drift
```

- **local stratum 8** указывает, что этот сервер является локальным и имеет стратум 8 (стратум — это показатель точности времени).
- **manual** указывает, что этот сервер не синхронизируется с внешними серверами времени, а работает в ручном режиме.
- **allow <ip_address>/<subnet_mask>** разрешает доступ для синхронизации времени с указанным IP-адресом или подсетью.
- **driftfile /var/lib/chrony/drift** указывает путь к файлу, в котором будет сохраняться информация об изменении времени.

Объяснение параметров:

**local stratum 8**<br>
указывает уровень точности времени сервера. Чем ниже стратум, тем точнее часы. Для локального сервера достаточно 8-10.<br>
**manual**<br>
указывает, что сервер не синхронизируется с внешними серверами.<br>
**allow**<br>
контролирует, кто может получить время от локального сервера. Рекомендуется разрешать доступ только из локальной сети или от конкретных хостов.<br>
**driftfile**<br>
файл, в котором хранится информация о сдвиге времени. Chrony использует его для более точной синхронизации, когда внешние источники недоступны.


#### Установка службы NTP.
Добавим и запустить службу синхронизации времени ntp в автозапуск:
```bash
sudo systemctl status ntp
sudo systemctl start ntp
sudo systemctl enable ntp
```
Проверить работоспособность службы NTP в консоли с помощью команды: ``ntpq -p``

Настроить на локальный сервер можно здесь ``nano /etc/ntp.conf``
Добавить в соответствующей секции следующие строки:
```bash
server 127.127.1.0
fudge 127.127.1.0 stratum 10
restrict <network> mask <netmask> nomodify notrap

sudo systemctl enable ntp
sudo systemctl restart ntp
ntpq -p
remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 LOCAL(0)        .LOCL.          10 l    7   64    1    0.000   +0.000   0.000
```
